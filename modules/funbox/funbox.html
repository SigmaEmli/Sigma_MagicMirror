<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" type="text/css" href="./funbox.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.30.1/moment.min.js"></script>
  </head>
  <body>
    <main>
      <div class="funbox">
        <menu class="funbox-menu">
          <li data-target="birthday-box" class="birthday-menu-item active">Birthdays</li>
          <li data-target="cat-box" class="cat-menu-item">Cats</li>
          <li data-target="meme-box" class="meme-menu-item">Memes</li>
        </menu>
        <div id="birthday-box" class="box birthday-box active">
          <h3 class="title">Upcoming Birthdays</h3>
          <ul class="birthday-people"></ul>
        </div>
        <div id="cat-box" class="box cat-box"></div>
        <div id="meme-box" class="box meme-box"></div>
      </div>
    </main>
    <script type="module">
      import { peopleData } from "./people.js";

      const birthdaypeople = [];
      const upcomingBirthdays = [];
      const manyItems = document.querySelectorAll("menu li");
      let previous = document.querySelector(".birthday-box");
      let previousListItem = manyItems[0];
      const currentDate = moment("YYYY-MM-DD");
      poppulateData();
      manyItems.forEach((item) => {
        item.addEventListener("click", () => {
          const target = item.getAttribute("data-target");
          if (target === "cat-box") {
            fetchCats();
            disableMenuItem("cat-menu-item");
          }
          if (target === "meme-box") {
            fetchMemes();
            disableMenuItem("meme-menu-item");
          }

          const boxTarget = document.querySelector(`.${target}`);
          const boxTargetHasClass = boxTarget.classList.contains(target);

          if (previous && previous !== boxTarget) previous.classList.remove("active");
          if (previousListItem && previousListItem !== target) previousListItem.classList.remove("active");

          item.classList.add("active");
          document.querySelector(`.${target}`).classList.add("active");

          previous = boxTarget;
          previousListItem = item;
        });
      });

      function poppulateData() {
        // const filteredData = filterData();
        const filteredData = sortByUpcomingBirthdays();
        const parentElement = document.querySelector(".birthday-people");

        for (let i = 0; i < filteredData.length; i++) {
          const birthdayClass = setBirthdayClass(filteredData[i].birthdate);
          const birthDate = new Date(filteredData[i].birthdate);
          const format = Intl.DateTimeFormat("sv-SE", {
            day: "2-digit",
            month: "2-digit"
          });
          const formatDate = format.format(birthDate);
          const peopleElement = `
            <li class="birthday-person ${birthdayClass}">
             <div class="person-info border">
               <p>${filteredData[i].name}</p>
              <p>${formatDate}</p>
              </div>
            </li>
            `;
          parentElement.insertAdjacentHTML("afterbegin", peopleElement);
        }
      }
      function sortByUpcomingBirthdays() {
        return peopleData.sort((a, b) => {
          const currentDate = moment().year();
          const today = moment().format("YYYY-MM-DD");
          const birthdayA = moment(`${currentDate}/${moment(a.birthdate).format("MM/DD")}`);
          const birthdayB = moment(`${currentDate}/${moment(b.birthdate).format("MM/DD")}`);
          if (birthdayA.format("YYYY-MM-DD") < today) {
            birthdayA.add(1, "y");
          }
          if (birthdayB.format("YYYY-MM-DD") < today) {
            birthdayB.add(1, "y");
          }
          const dateA = moment(birthdayA.format("YYYY-MM-DD"));
          const dateB = moment(birthdayB.format("YYYY-MM-DD"));
          return dateB - dateA;
        });
      }
      function showCaseBirthday(data) {
        const today = moment().format("MM-DD");
        if (today === moment(data.birthdate).format("MM-DD")) {
          const parentElement = document.querySelector(".birthday-people");
          const peopleElement = `
            <li class="birthday-person">
             <div class="person-info border">
               <p>${data.name}</p>
               <p>${today}</p>
              </div>
            </li>
            `;
          parentElement.insertAdjacentHTML("afterbegin", peopleElement);
        }
      }
      function setBirthdayClass(data) {
        const today = moment().format("MM-DD");
        return today === moment(data).format("MM-DD") ? "birthday" : "";
      }

      function fetchCats() {
        fetch("https://api.thecatapi.com/v1/images/search")
          .then((response) => response.json())
          .then((data) => {
            document.querySelector(".cat-box").innerHTML = `<img class="cat-img" src="${data[0].url}" />`;
          });
      }

      function fetchMemes() {
        fetch("https://meme-api.com/gimme")
          .then((response) => response.json())
          .then((data) => {
            document.querySelector(".meme-box").innerHTML = `<img class="meme-img" src="${data.url}" />`;
          });
      }

      function disableMenuItem(menuItem) {
        let lastClickTime = 0;
        const cooldownDuration = 5000;
        document.querySelector(`.${menuItem}`).classList.add("menu-disabled");
        setTimeout(() => {
          document.querySelector(`.${menuItem}`).classList.remove("menu-disabled");
        }, cooldownDuration);
      }
    </script>
  </body>
</html>
